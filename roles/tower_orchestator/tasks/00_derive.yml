---
- name: Normalize survey inputs
  set_fact:
    region_norm: "{{ (region | default('EMEA')) | upper }}"
    env_norm: "{{ (envs | default('DEV')) | upper }}"
    product_norm: "{{ (product | default('')) | lower }}"

- name: Derive product family from product string
  set_fact:
    product_family: >-
      {% set p = product_norm %}
      {% if 'tomcat' in p %}tomcat
      {% elif 'weblogic' in p %}weblogic
      {% elif 'jboss' in p or 'jbosseap' in p %}jboss
      {% elif 'sso' in p %}sso
      {% elif 'apache' in p %}apache
      {% elif 'iis' in p %}iis
      {% elif 'was' in p or 'websphere' in p %}was
      {% else %}tomcat{% endif %}

- name: Derive zone override (dmz/lbi) from product string
  set_fact:
    zone_override: >-
      {% set p = product_norm %}
      {% if ('_lbi' in p) or ('lbi' in p) %}lbi
      {% elif ('_dmz' in p) or ('dmzi' in p) or ('_mzr' in p) %}dmz
      {% else %}none{% endif %}

- name: Select playbook + inventory source path
  set_fact:
    playbook_path: "{{ product_map[product_family].playbook }}"
    ini_source_path: "{{ product_map[product_family].ini }}"

- name: Select credential id (zone override > region)
  set_fact:
    cred_id: >-
      {{
        (zone_credentials[zone_override] if zone_override != 'none'
         else region_credentials[region_norm]) | int
      }}

- name: Select instance group name by region
  set_fact:
    instance_group_name: "{{ region_instance_groups[region_norm] }}"

- name: Set launch limit to selected product group
  set_fact:
    launch_limit: "{{ product }}"
