---
- name: "Starting block for Ansible Token"
  block:
    - name: "Create Ansible Token"
      uri:
        url: "{{ ansible_url }}/tokens/"
        validate_certs: false
        method: POST
        status_code: [200, 201]
        headers:
          Accept: application/json
        url_username: "{{ api_username }}"
        url_password: "{{ api_password }}"
        force_basic_auth: true
        body_format: json
        body:
          description: ""
      register: token_info

    - name: "Set_fact of svc_token"
      set_fact:
        svc_token: "{{ token_info.json.token }}"

- name: Normalize survey inputs parsed via AWX cli
  set_fact:
    region_norm: "{{ (region | mandatory | upper | trim) }}"
    env_norm: "{{ (envs | mandatory | upper | trim) }}"
    product_norm: "{{ (product | mandatory | trim) }}"
    update: "{{ (update | mandatory | lower | trim) }}"
    instance_group: "{{ (instance_group | mandatory | trim) }}"
    data_env: "{{ (data_env | mandatory | trim) }}"
    is_ETS: "{{ (update | mandatory | trim) }}"

- name: Normalize limit parsed via AWX cli
  set_fact:
    limit_defined: "{{ product_norm }}_{{ region | lower | trim }}_{{ envs | lower | trim }}_CORE"

- name: Debug of limit
  debug:
    msg: "Actual value of limit: {{ limit_defined }}"

- name: Derive product family from product string
  set_fact:
    product_family: >-
      {% set p = product_norm %}
      {% if 'tomcat' in p %}tomcat
      {% elif 'weblogic' in p %}weblogic
      {% elif 'jboss' in p or 'jbosseap' in p %}jboss
      {% elif 'sso' in p %}sso
      {% elif 'apache' in p %}apache
      {% elif 'iis' in p %}iis
      {% elif 'was' in p or 'websphere' in p %}was
      {% else %}UNKNOWN{% endif %}

- name: Normalize product_family
  set_fact:
    product_family: "{{ product_family | trim }}"

- name: Abort if product family could not be detected
  assert:
    that:
      - product_family != 'UNKNOWN'
      - product_family in product_map
    fail_msg: "Unable to determine product family from \"{{ product_norm }}\" (product_family='{{ product_family }}')"

- name: Select playbook + inventory source path
  set_fact:
    playbook_path: "{{ product_map[product_family].playbook }}"
    ini_source_path: "{{ product_map[product_family].ini }}"

- name: Derive zone override (dmz/lbi) from product string
  set_fact:
    zone_override: >-
      {% set p = product_norm %}
      {% if ('_lbi' in p) or ('lbi' in p) %}lbi
      {% elif ('_dmz' in p) or ('dmzi' in p) or ('_mzr' in p) %}dmz
      {% else %}none{% endif %}

- name: Normalize zone_override
  set_fact:
    zone_override: "{{ zone_override | trim | lower }}"

- name: Validate credential lookup
  assert:
    that:
      - region_norm in region_credentials
      - zone_override == 'none' or zone_override in zone_credentials
    fail_msg: "Invalid region_norm='{{ region_norm }}' or zone_override='{{ zone_override }}'"

- name: Select credential id (zone override > region)
  set_fact:
    cred_id: >-
      {{
        (
          zone_credentials[zone_override]
          if zone_override != 'none'
          else region_credentials[region_norm]
        ) | int
      }}

- name: Set instance_group_name (with fallback)
  set_fact:
    instance_group_name: >-
      {{ region_instance_groups[region_norm] | default('MiddlewareFR') }}
    instance_group: >-
      {{ region_instance_groups[region_norm] | default('MiddlewareFR') }}

- name: Normalize instance_group override
  set_fact:
    instance_group_name_override: "{{ (instance_group | default('')) | trim }}"

- name: Set instance_group_name (with fallback)
  set_fact:
    instance_group_name: >-
      {{ region_instance_groups[region_norm] | default('MiddlewareFR') }}
    instance_group: >-
      {{ region_instance_groups[region_norm] | default('MiddlewareFR') }}

- name: Normalize instance_group override
  set_fact:
    instance_group_name_override: "{{ (instance_group |default ('') ) | trim }}"

- name: Select instance_group id after override
  set_fact:
    instance_group_name_final: >-
      {{
        instance_group_name_override
        if instance_group_name_override | length > 0
        else region_instance_groups[region_norm]
      }}

- name: Resolve instance_group_id from final name
  set_fact:
    instance_group_id: "{{ instance_group_name_to_id[instance_group_name_final]}}"
  when: instance_group_name_final is not none

- name: Set launch limit to selected product
  set_fact:
    launch_limit: "{{ limit_defined | lower }}"
